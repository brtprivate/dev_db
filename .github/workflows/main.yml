name: Deploy to Server

on:
  push:
    branches: [ dev, main, master ]
  pull_request:
    types: [closed]
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to server (with Git fix)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd ${{ secrets.PROJECT_PATH }}
          echo "Current directory: $(pwd)"
          
          # Fix Git permissions properly
          echo "Fixing Git directory permissions..."
          
          # Check current user and permissions
          echo "Current user: $(whoami)"
          echo "Current directory permissions:"
          ls -la .git/ 2>/dev/null || echo "No .git directory found"
          
          # Fix ownership and permissions
          sudo chown -R $(whoami):$(whoami) .git/ 2>/dev/null || echo "sudo chown failed, trying without sudo"
          chown -R $(whoami):$(whoami) .git/ 2>/dev/null || echo "chown failed"
          
          sudo chmod -R 755 .git/ 2>/dev/null || echo "sudo chmod failed, trying without sudo"
          chmod -R 755 .git/ 2>/dev/null || echo "chmod failed"
          
          # Test if Git is working now
          if ! git status >/dev/null 2>&1; then
            echo "Git still not working. Recreating Git repository..."
            # Backup current .git
            mv .git .git.broken 2>/dev/null || true
            
            # Initialize fresh Git repository
            git init
            git remote add origin https://github.com/brtprivate/dev_db.git
            
            # Set up Git configuration
            git config user.name "Deployment Bot"
            git config user.email "deploy@example.com"
          fi
          
          # Configure Git safe directory
          git config --global --add safe.directory ${{ secrets.PROJECT_PATH }}
          
          # Ensure remote is correct
          git remote set-url origin https://github.com/brtprivate/dev_db.git
          
          # Fetch latest changes
          echo "Fetching latest changes from origin..."
          git fetch origin
          
          # Check available branches
          echo "Available remote branches:"
          git branch -r
          
          # Pull from master branch
          echo "Pulling from master branch..."
          if git pull origin master; then
            echo "Git pull successful!"
          else
            echo "Git pull failed. Trying hard reset..."
            git reset --hard origin/master
            echo "Hard reset completed!"
          fi
          
          # Verify the pull worked
          echo "Current branch status:"
          git status
          echo "Latest commit:"
          git log --oneline -1
          
          echo "Deployment completed successfully!"
